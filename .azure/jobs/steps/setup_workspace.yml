parameters:
  underlay: ''
  key: ''
  workspace: ''
  mixins: ''
  build: true

steps:
- task: PublishPipelineArtifact@1
  inputs:
    path: ${{ parameters.workspace }}/checksum.txt
    artifact: ${{ parameters.key }}_checksum
# - restore_from_cache:
#   key: << parameters.key >>
#   workspace: << parameters.workspace >>
# - when:
#   condition: << parameters.build >>
- script: |
    if [ -d install ] && [ ! -f build_failed ]
    then
      echo "Skipping Build"
    else
      . ${{ parameters.underlay }}/install/setup.sh
      rm -rf build install log
      colcon build \
        --symlink-install \
        --mixin ${{ parameters.mixins }}
      rm -f build_failed
    fi
  displayName: Build Workspace | ${{ parameters.workspace }}
  name: build_${{ parameters.key }}_workspace
  workingDirectory: ${{ parameters.workspace }}
  enabled: ${{ parameters.build }}
# - save_to_cache:
#   key: << parameters.key >>
#   path: << parameters.workspace >>
#   workspace: << parameters.workspace >>
- script: cp -rH log/latest_build log/build
  displayName: Copy Build Logs
  name: copy_${{ parameters.key }}_build_logs
  workingDirectory: ${{ parameters.workspace }}
- task: PublishPipelineArtifact@1
  inputs:
    path: ${{ parameters.workspace }}/log/build
    artifact: ${{ parameters.key }}_build_log
