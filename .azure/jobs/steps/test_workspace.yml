parameters:
  key: ''
  workspace: ''
  mixins: ''

steps:
- script: |
    . install/setup.sh
    set -o xtrace
    colcon test \
      --mixin ${{ parameters.mixins }}
  displayName: Test Workspace | ${{ parameters.workspace }}
  name: test_${{ parameters.key }}_workspace
  workingDirectory: ${{ parameters.workspace }}
  continueOnError: true
- script: |
    mkdir rm -rf $(Pipeline.Workspace)/${{ parameters.key }}/test_results
    mkdir -p $(Pipeline.Workspace)/${{ parameters.key }}/test_results
    cp -rH \
      build/*/test_results/* \
      $(Pipeline.Workspace)/${{ parameters.key }}/test_results
  displayName: Copy Test Results | ${{ parameters.workspace }}
  name: copy_${{ parameters.key }}_test_results
  workingDirectory: ${{ parameters.workspace }}
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '*/*.xml'
    searchFolder: '$(Pipeline.Workspace)/${{ parameters.key }}/test_results'
    buildPlatform: $(Agent.OS)-$(Agent.OSArchitecture)
    buildConfiguration: ${{ variables.UNDERLAY_MIXINS }}
- script: |
    colcon test-result \
      --verbose
  displayName: Test Workspace Result | ${{ parameters.workspace }}
  name: test_${{ parameters.key }}_workspace_result
  workingDirectory: ${{ parameters.workspace }}