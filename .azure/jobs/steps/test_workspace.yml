parameters:
  key: ''
  workspace: ''
  mixins: ''

steps:
- script: |
    . install/setup.sh
    TEST_PACKAGES=$(
      colcon list --names-only | \
        circleci tests split \
          --split-by=timings \
          --timings-type=classname \
          --show-counts | \
        xargs)
    set -o xtrace
    colcon test \
      --packages-select ${TEST_PACKAGES} \
      --mixin ${{ parameters.mixins }}
    colcon test-result \
      --verbose
  displayName: Test Workspace | ${{ parameters.workspace }}
  name: test_${{ parameters.key }}_workspace
  workingDirectory: ${{ parameters.workspace }}
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit, cTest
    testResultsFiles: '*/test_results/*' 
    searchFolder: '${{ parameters.workspace }}/build' # Optional
    # mergeTestResults: false # Optional
    failTaskOnFailedTests: true # Optional
    # testRunTitle: # Optional
    # buildPlatform: # Optional
    # buildConfiguration: # Optional
    # publishRunAttachments: true # Optional

# - run:
#   name: Copy Test Logs
#   working_directory: << parameters.workspace >>
#   command: cp -rH log/latest_test log/test
#   when: always
# - store_artifacts:
#   path: << parameters.workspace >>/log/test
# - run:
#   name: Copy Test Results
#   working_directory: << parameters.workspace >>
#   command: |
#     mkdir test_results/
#     cp -rH build/*/test_results/* test_results
#   when: always
# - store_test_results:
#   path: << parameters.workspace >>/test_results
# - store_artifacts:
#   path: << parameters.workspace >>/test_results