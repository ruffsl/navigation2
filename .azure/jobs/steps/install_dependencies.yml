parameters:
  underlay: ''
  workspace: ''

steps:
- script: |
    sudo --preserve-env -u root bash << EOF
    cp -r /root/.ros $HOME
    whoami
    echo HOME $HOME
    ls ~/
    pwd
    ls $HOME/.ros/rosdep
    . ${{ parameters.underlay }}/install/setup.sh
    cat ${{ parameters.underlay }}/checksum.txt > checksum.txt
    vcs export --exact src | \
      (echo vcs_export && cat) >> checksum.txt
    sha256sum checksum.txt >> checksum.txt
    apt-get update
    dependencies=$(
      rosdep install -q -y \
        --sources-cache-dir /root/.ros/rosdep/sources.cache \
        --from-paths \
          $UNDERLAY_WS/src \
          src \
        --ignore-src \
        --verbose | \
      awk '$1 ~ /^resolution\:/' | \
      awk -F'[][]' '{print $2}' | \
      tr -d \, | xargs -n1 | sort -u | xargs)
    dpkg -s $dependencies | \
      (echo workspace_dependencies && cat) >> checksum.txt
    sha256sum checksum.txt >> checksum.txt
    EOF
  displayName: Install Dependencies ${{ parameters.workspace }}
  name: install_dependencies
  workingDirectory: ${{ parameters.workspace }}