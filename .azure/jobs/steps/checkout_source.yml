parameters:
  name: 'Build'
  pool: 'Default'
  container: ''

steps:
- script: |
    mkdir -p $ROS_WS
    ln -s /opt/ros/$ROS_DISTRO $ROS_WS/install
    echo $CACHE_NONCE | \
      (echo cache_nonce && cat) >> $ROS_WS/checksum.txt
    sha256sum $ROS_WS/checksum.txt >> $ROS_WS/checksum.txt
    TZ=utc stat -c '%y' /ros_entrypoint.sh | \
      (echo ros_entrypoint && cat) >> $ROS_WS/checksum.txt
    sha256sum $ROS_WS/checksum.txt >> $ROS_WS/checksum.txt
    rm -rf $OVERLAY_WS/*
  displayName: Pre Checkout
  name: pre_checkout
- checkout: self
  path: "${{ variables.OVERLAY_WS }}/src/navigation2"
- script: |
    rm $OVERLAY_WS/src/navigation2/nav2_system_tests/COLCON_IGNORE
    if ! cmp \
      $OVERLAY_WS/src/navigation2/tools/ros2_dependencies.repos \
      $UNDERLAY_WS/ros2_dependencies.repos >/dev/null 2>&1
    then
      echo "Cleaning Underlay"
      rm -rf $UNDERLAY_WS/*
      cp $OVERLAY_WS/src/navigation2/tools/ros2_dependencies.repos \
        $UNDERLAY_WS/ros2_dependencies.repos
      mkdir -p $UNDERLAY_WS/src
      vcs import $UNDERLAY_WS/src \
        < $UNDERLAY_WS/ros2_dependencies.repos
    fi
  displayName: Post Checkout
  name: post_checkout